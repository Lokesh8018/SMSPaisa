generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum SmsStatus {
  QUEUED
  ASSIGNED
  SENT
  DELIVERED
  FAILED
}

enum LogStatus {
  SENT
  DELIVERED
  FAILED
}

enum TransactionType {
  EARNING
  WITHDRAWAL
  REFERRAL_BONUS
  SIGNUP_BONUS
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

model User {
  id           String   @id @default(uuid())
  phone        String   @unique
  name         String?
  email        String?
  referralCode String   @unique
  referredById String?
  referredBy   User?    @relation("UserReferrals", fields: [referredById], references: [id])
  referrals    User[]   @relation("UserReferrals")
  password     String?
  kycVerified  Boolean  @default(false)
  isActive     Boolean  @default(true)
  role         Role     @default(USER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  wallet          Wallet?
  devices         Device[]
  smsTasks        SmsTask[]        @relation("AssignedTasks")
  smsLogs         SmsLog[]
  transactions    Transaction[]
  referralsMade   Referral[]       @relation("ReferrerRelation")
  referralReceived Referral?       @relation("ReferredRelation")
}

model Wallet {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  balance        Decimal  @default(0.00) @db.Decimal(10, 2)
  totalEarned    Decimal  @default(0.00) @db.Decimal(10, 2)
  totalWithdrawn Decimal  @default(0.00) @db.Decimal(10, 2)
  updatedAt      DateTime @updatedAt
}

model SmsTask {
  id               String    @id @default(uuid())
  recipient        String
  message          String
  status           SmsStatus @default(QUEUED)
  assignedToId     String?
  assignedTo       User?     @relation("AssignedTasks", fields: [assignedToId], references: [id])
  assignedDeviceId String?
  assignedDevice   Device?   @relation(fields: [assignedDeviceId], references: [id])
  clientId         String
  priority         Int       @default(0)
  createdAt        DateTime  @default(now())
  assignedAt       DateTime?
  sentAt           DateTime?
  deliveredAt      DateTime?

  smsLogs SmsLog[]
}

model SmsLog {
  id           String    @id @default(uuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id])
  taskId       String
  task         SmsTask   @relation(fields: [taskId], references: [id])
  status       LogStatus
  amountEarned Decimal   @default(0.00) @db.Decimal(10, 2)
  sentAt       DateTime?
  deliveredAt  DateTime?
  createdAt    DateTime  @default(now())

  @@unique([taskId, status])
}

model Transaction {
  id               String            @id @default(uuid())
  userId           String
  user             User              @relation(fields: [userId], references: [id])
  type             TransactionType
  amount           Decimal           @db.Decimal(10, 2)
  status           TransactionStatus @default(PENDING)
  paymentMethod    String?
  paymentDetails   Json?
  razorpayPayoutId String?
  description      String?
  createdAt        DateTime          @default(now())
}

model Device {
  id               String    @id @default(uuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id])
  deviceName       String
  deviceId         String    @unique
  simInfo          Json?
  dailyLimit       Int       @default(300)
  activeHoursStart String    @default("09:00")
  activeHoursEnd   String    @default("21:00")
  isOnline         Boolean   @default(false)
  lastSeen         DateTime?
  smsSentToday     Int       @default(0)
  createdAt        DateTime  @default(now())

  smsTasks SmsTask[]
}

model Referral {
  id             String   @id @default(uuid())
  referrerId     String
  referrer       User     @relation("ReferrerRelation", fields: [referrerId], references: [id])
  referredId     String   @unique
  referred       User     @relation("ReferredRelation", fields: [referredId], references: [id])
  bonusPaid      Boolean  @default(false)
  referrerBonus  Decimal  @default(10.00) @db.Decimal(10, 2)
  referredBonus  Decimal  @default(5.00)  @db.Decimal(10, 2)
  createdAt      DateTime @default(now())
}

model PlatformSettings {
  id                String   @id @default("default")
  perRoundSendLimit Int      @default(25)
  updatedAt         DateTime @updatedAt
}
